解决查询缓慢的问题
=========

### 背景介绍
业务开发中遇到批量添加卡片，一次最多添加1w张卡，同时需要存储卡片的销售历史信息。  
拿到需求，对表进行了设计：  
card_batch表，包含批次号等信息；  
card表，包含卡号及秘钥信息；  
card_detail表，包含卡的制卡，销售，激活，兑换，过期等信息；这张表是为了将card的经常变化的数据进行存储；  
card_sale_info表，包含卡片的出售信息；  
其中card表中使用batch_number和card_batch进行关联，card_detail和card_sale_info使用card_number与card表进行关联；  
在开始没有考虑到数据量过大的问题，所以每添加一张卡片，card表和card_detail表就会插入一条数据；  
所以在数据量超过十万的时候，通过一般的连接查询就会变得很缓慢。
#### 初次尝试解决
1. 添加索引，将card_batch的batch_number添加唯一索引，card及card_detail表的card_number添加唯一索引。  
    这样在连接查询时可以通过索引查询，会提升一定的速度。此时速度提升了1/4。
2. 修改业务逻辑，业务逻辑中获取字典数据时会经常访问数据库，连接数据库的时间耗时比较大。  
    将字典数据获取出来放进缓存redis，这时也会每次都访问redis，每次连接也会有时间消耗，在数据量大时这个消耗也是一个不能忽略的问题。  
    在一次请求中将redis中缓存数据放进jvm运行内存中，这样就能直接从jvm中获取，可以将连接redis和mysql的时间消耗降低为0。
3. 修改sql语句，sql语句中的关联是在where中进行关联，当数据量大的时候，这个笛卡尔积会很庞大。
    将笛卡尔积修改为外连接，使用left join来进行关联，以card中的数据为主表进行查询。此时查询数据时不会使用mysql很大的缓存空间，提高了效率。  
这个时候第一次优化结束，但是在数据量增加到8w-10w的时候，查询依然比较缓慢。

#### 再次解决
1. 修改表设计，考虑到card和card_detail中的数据量是一样的，在关联查询时，会是一个很庞大的查询结果。所以将card和card_detail融合成一张表。
    一开始考虑的是将不变的数据和可变的数据分开存储，以方便读写的效率。但是现阶段的业务读的需求远大于写，所以将两张表合并为在一张表是可行的。
2. 再次优化sql语句，在关联查询时，先将card表的数据根据条件查询出来，再进行left join进行关联，这样能减少查询时关联数据的大小，避免全表关联。
这次优化后，速度提升了一半，在10w数据量的时候，耗时大约是10s。能够满足业务的需求，毕竟这个功能在日常使用中应该不会超过10w的数据。

#### 最终解决
1. 再次修改表设计，查询时很多会关联查询card_batch中的数据，但其实card_batch中的数据可以冗余到card中，如果都在一张表中进行查询，使用索引就会很快了。
2. 修改业务代码，以前是将很多的查询公用一个sql语句，但是不同的业务使用到的字段是不一致的，所以可以将sql根据实际的每个业务进行编写。  
    在冗余后只用到card表中的数据的查询，就使用单表查询，利用索引的效率，可以将时间控制在1s以内。  
    需要用到销售数据和其他的数据，在单独的编写sql语句，进行关联查询，避免在业务中频繁访问数据库，所以使用关联查询会有效的提升效率。
3. 最终优化sql语句，把能单表查询的利用子查询先查询出来，这里索引很有用；然后再进行关联查询；这样既能避免关联时全表关联，也能有效的利用到索引。

### 结果
通过三次优化，成功的将几万条数据查询需要几十秒的情况，优化到几十万的数据查询不到1s的情况。可以说是很厉害了。



